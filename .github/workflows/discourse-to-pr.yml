name: Create PR from PKMer Forum Post

on:
  repository_dispatch:
    types: [PKMer_forum_post]

jobs:
  create-pr:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Setup Git
      run: |
        git config --global user.name "pkmer Bot"
        git config --global user.email "pkmer.cn"
    
    - name: Create content from  PKMer Forum post
      id: create_content
      env:
        POST_AUTHOR: ${{ github.event.client_payload.author }}
        POST_TITLE: ${{ github.event.client_payload.title }}
        POST_TAGS_JSON: ${{ toJSON(github.event.client_payload.tags) }}
        POST_TIMESTAMP: ${{ github.event.client_payload.timestamp }}
        POST_SOURCE_URL: ${{ github.event.client_payload.source_url }}
        POST_RAW_CONTENT: ${{ github.event.client_payload.raw }}
      run: |
        # åˆ›å»ºæ–‡ä»¶è·¯å¾„å’Œå†…å®¹
        POST_ID="${{ github.event.client_payload.post_id }}"
        TOPIC_ID="${{ github.event.client_payload.topic_id }}"
        TIMESTAMP=$(date +%Y%m%d_%H%M%S)
        
        # æ¸…ç†æ ‡é¢˜ä»¥ç”¨ä½œæ–‡ä»¶åçš„ä¸€éƒ¨åˆ†ï¼Œæ›´å‹å¥½
        CLEAN_TITLE=$(echo "$POST_TITLE" | tr -d '[:punct:]' | tr ' ' '-')
        FILENAME="${TOPIC_ID}-${CLEAN_TITLE}.md"
        # æ ‡ç­¾æ•°ç»„è½¬å­—ç¬¦ä¸²
        TAGS_STRING=$(echo "$POST_TAGS_JSON" | jq -r 'join(", ")')
        # è®¾ç½®æ–‡ä»¶è·¯å¾„ï¼ˆå¯ä»¥æ ¹æ®éœ€è¦ä¿®æ”¹ï¼‰
        FILEPATH="PKMerè®ºå›/${FILENAME}"
        
        # åˆ›å»ºç›®å½•
        mkdir -p $(dirname "$FILEPATH")
        
        # åˆ›å»º Markdown æ–‡ä»¶å†…å®¹
        cat > "$FILEPATH" << EOF
        ---
        uid: ${POST_ID}
        title: ${POST_TITLE}
        tags: [${TAGS_STRING}]
        description: ${POST_TITLE}
        author: ${POST_AUTHOR}
        type: other
        draft: false
        editable: false
        modified: ${POST_TIMESTAMP}
        forum_url: ${POST_SOURCE_URL}
        topic_id: ${TOPIC_ID}
        ---
        
        # ${POST_TITLE}
        
        > æœ¬æ–‡æ¡£ç”± PKMer è®ºå›è‡ªåŠ¨å¯¼å…¥  
        > - ä½œè€…: ${POST_AUTHOR}
        > - åŸå§‹é“¾æ¥: <${POST_SOURCE_URL}>  
        > - å¸–å­ç¼–å·: #${POST_ID}
        
        ---
        
        ${POST_RAW_CONTENT}
        
        EOF
        
        echo "filepath=$FILEPATH" >> $GITHUB_OUTPUT
        echo "filename=$FILENAME" >> $GITHUB_OUTPUT
        
    - name: Create Pull Request
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: |
          æ·»åŠ  PKMerè®ºå› å¸–å­: ${{ github.event.client_payload.title }}
          
          - Post ID: ${{ github.event.client_payload.post_id }}
          - Author: ${{ github.event.client_payload.author  }}
          - Source: ${{ github.event.client_payload.source_url }}
        branch: forum-post-${{ github.event.client_payload.post_id }}
        delete-branch: true
        title: |
          ${{ github.event.client_payload.title }}
        body: |
          ## ğŸ“ PKMerè®ºå› å¸–å­å¯¼å…¥
          
          æœ¬ PR è‡ªåŠ¨ä»  PKMer è®ºå›å¯¼å…¥å¸–å­å†…å®¹ã€‚
          
          ### å¸–å­ä¿¡æ¯
          - **æ ‡é¢˜**: ${{ github.event.client_payload.title }}
          - **ä½œè€…**: @${{ github.event.client_payload.author }}
          - **å¸–å­ ID**: ${{ github.event.client_payload.post_id }}
          - **åŸå§‹é“¾æ¥**: ${{ github.event.client_payload.source_url }}
          
          ### æ–‡ä»¶è·¯å¾„
          - ğŸ“„ `${{ steps.create_content.outputs.filepath }}`
          
          
      
        labels: |
          auto-generated
          documentation
        assignees: |
          ${{ github.repository_owner }}
          
    - name: PR Created Successfully
      if: success()
      run: |
        echo "âœ… PR åˆ›å»ºæˆåŠŸï¼"
        echo "Post ID: ${{ github.event.client_payload.post_id }}"
        echo "Topic: ${{ github.event.client_payload.title }}"
        
    - name: Handle Failure
      if: failure()
      run: |
        echo "âŒ PR åˆ›å»ºå¤±è´¥"
        echo "Error details available in workflow logs"
