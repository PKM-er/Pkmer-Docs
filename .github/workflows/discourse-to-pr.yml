name: Create Doc from PKMer Forum Post

on:
  repository_dispatch:
    types: [PKMer_forum_post]

# ã€ä¿®æ­£ã€‘ä¸º git push æ“ä½œæ·»åŠ æƒé™
permissions:
  contents: write

jobs:
  commit-to-main:
    runs-on: ubuntu-latest
    
    steps:
    # ã€æ¨èã€‘æ›´æ˜ç¡®å’Œå¥å£®çš„ checkout
    - name: Checkout main branch
      uses: actions/checkout@v3
      with:
        ref: main
        token: ${{ secrets.PAT_TOKEN }}
        fetch-depth: 0
        
    - name: Setup Git
      run: |
        git config --global user.name "pkmer Bot"
        git config --global user.email "bot@pkmer.cn"

    - name: 1. Prepare file details and check for updates
      id: prepare_file
      env:
        POST_TITLE: ${{ github.event.client_payload.title }}
        TOPIC_ID: ${{ github.event.client_payload.topic_id }}
      run: |
        # ã€æ¨èã€‘ä½¿ç”¨æ›´å®Œå–„çš„æ–‡ä»¶åæ¸…ç†é€»è¾‘
        CLEAN_TITLE=$(echo "$POST_TITLE" | tr -d '[:punct:]' | tr ' ' '-')
        FILENAME="${TOPIC_ID}-${CLEAN_TITLE}.md"
        FILEPATH="PKMerè®ºå›/${FILENAME}"
        
        echo "filepath=${FILEPATH}" >> $GITHUB_OUTPUT
        if [ -f "$FILEPATH" ]; then
          echo "is_update=true" >> $GITHUB_OUTPUT
        else
          echo "is_update=false" >> $GITHUB_OUTPUT
        fi

    - name: 2. Create content from PKMer Forum post
      id: create_content
      env:
        FORUM_BASE_URL: "https://forum.pkmer.net"
        POST_ID: ${{ github.event.client_payload.post_id }}
        TOPIC_ID: ${{ github.event.client_payload.topic_id }}
        POST_AUTHOR: ${{ github.event.client_payload.author }}
        POST_TITLE: ${{ github.event.client_payload.title }}
        POST_TAGS_JSON: ${{ toJSON(github.event.client_payload.tags) }}
        POST_TIMESTAMP: ${{ github.event.client_payload.timestamp }} # å»ºè®®ä½¿ç”¨ ISO æ ¼å¼æ—¶é—´æˆ³
        POST_SOURCE_URL: ${{ github.event.client_payload.source_url }}
        POST_RAW_CONTENT: ${{ github.event.client_payload.raw }}
        FILE_PATH: ${{ steps.prepare_file.outputs.filepath }}
      run: |
        set -x # å¼€å¯è°ƒè¯•æ¨¡å¼ï¼Œæ‰“å°æ¯æ¡å‘½ä»¤

        FULL_FORUM_URL="$POST_SOURCE_URL"
        if [[ ! "$POST_SOURCE_URL" == http* ]]; then
          FULL_FORUM_URL="${FORUM_BASE_URL}${POST_SOURCE_URL}"
        fi
        
        # æ ‡ç­¾æ•°ç»„è½¬å­—ç¬¦ä¸²ï¼Œå¹¶ç§»é™¤ "ç²¾å" æ ‡ç­¾
        TAGS_STRING=$(echo "$POST_TAGS_JSON" | jq -r 'map(select(. != "ç²¾å")) | join(", ")')
       
   
        # ã€ä¿®æ­£ã€‘ä½¿ç”¨ $FILE_PATH å˜é‡
        mkdir -p "$(dirname "$FILE_PATH")"
        
        # ã€ä¿®æ­£ã€‘ä½¿ç”¨ $FILE_PATH å˜é‡
        cat > "$FILE_PATH" << EOF
        ---
        uid: ${POST_ID}
        title: ${POST_TITLE}
        tags: [${TAGS_STRING}]
        description: ${POST_TITLE}
        author: ${POST_AUTHOR}
        type: other
        draft: false
        editable: false
        modified: ${POST_TIMESTAMP}
        forum_url: ${FULL_FORUM_URL}
        ---
        
        # ${POST_TITLE}
        
        > [!INFO] æœ¬æ–‡æ¡£ç”± PKMer è®ºå›å¯¼å…¥  
        > - ä½œè€…: ${POST_AUTHOR}
        > - åŸå§‹é“¾æ¥: [${POST_TITLE}](${FULL_FORUM_URL})
        
        ---
        
        ${POST_RAW_CONTENT}
        EOF

    - name: 3. Commit and Push to main branch
      run: |
        # æŠŠæ–°åˆ›å»ºæˆ–ä¿®æ”¹çš„æ–‡ä»¶æ·»åŠ åˆ°æš‚å­˜åŒº
        git add '${{ steps.prepare_file.outputs.filepath }}'
        
        # æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶å˜æ›´ã€‚å¦‚æœæ²¡æœ‰å˜æ›´ï¼ˆæ¯”å¦‚é‡å¤è§¦å‘ï¼‰ï¼Œå°±é€€å‡º
        if git diff --staged --quiet; then
          echo "âœ… No changes to commit. Working tree clean."
          exit 0
        fi
        # æ ¹æ®æ˜¯æ›´æ–°è¿˜æ˜¯æ–°å»ºï¼Œç”Ÿæˆä¸åŒçš„ commit message
        COMMIT_MESSAGE="docs(forum): ${{ steps.prepare_file.outputs.is_update == 'true' && 'æ›´æ–°å¸–å­' || 'æ·»åŠ æ–°å¸–' }} L${{ github.event.client_payload.topic_id }}
        - æ ‡é¢˜: ${{ github.event.client_payload.title }}"
        
        # æ‰§è¡Œæäº¤
        git commit -m "$COMMIT_MESSAGE"
        
        # æ¨é€åˆ°è¿œç¨‹ main åˆ†æ”¯
        echo "ğŸš€ Pushing changes to main branch..."
        git push origin main
