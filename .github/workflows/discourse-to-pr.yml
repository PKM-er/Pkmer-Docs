name: Create PR from PKMer Forum Post

on:
  repository_dispatch:
    types: [PKMer_forum_post]

jobs:
  commit-to-main:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout main branch
      uses: actions/checkout@v3
      with:
        token: ${{ secrets.PAT_TOKEN }}
        
    - name: Setup Git
      run: |
        git config --global user.name "pkmer Bot"
        git config --global user.email "pkmer.cn"
    - name: 1. Prepare file details and check for updates
      id: prepare_file
      env:
        POST_TITLE: ${{ github.event.client_payload.title }}
        TOPIC_ID: ${{ github.event.client_payload.topic_id }}
      run: |
        CLEAN_TITLE=$(echo "$POST_TITLE" | iconv -t ascii//TRANSLIT | sed -r 's/[^a-zA-Z0-9]+/-/g' | sed -r 's/^-+\|-+$//g' | tr '[:upper:]' '[:lower:]')
        FILENAME="${TOPIC_ID}-${CLEAN_TITLE}.md"
        FILEPATH="PKMerè®ºå›/${FILENAME}"
        
        echo "filepath=${FILEPATH}" >> $GITHUB_OUTPUT
        if [ -f "$FILEPATH" ]; then
          echo "is_update=true" >> $GITHUB_OUTPUT
        else
          echo "is_update=false" >> $GITHUB_OUTPUT
        fi
    - name: Create content from  PKMer Forum post
      id: create_content
      env:
        FORUM_BASE_URL: "https://forum.pkmer.net"
        POST_AUTHOR: ${{ github.event.client_payload.author }}
        POST_TITLE: ${{ github.event.client_payload.title }}
        POST_TAGS_JSON: ${{ toJSON(github.event.client_payload.tags) }}
        POST_TIMESTAMP: ${{ github.event.client_payload.timestamp }}
        POST_SOURCE_URL: ${{ github.event.client_payload.source_url }}
        POST_RAW_CONTENT: ${{ github.event.client_payload.raw }}
      run: |
        # åˆ›å»ºæ–‡ä»¶è·¯å¾„å’Œå†…å®¹
        POST_ID="${{ github.event.client_payload.post_id }}"
        TOPIC_ID="${{ github.event.client_payload.topic_id }}"
        TIMESTAMP=$(date +%Y%m%d_%H%M%S)
        
        # æ¸…ç†æ ‡é¢˜ä»¥ç”¨ä½œæ–‡ä»¶åçš„ä¸€éƒ¨åˆ†ï¼Œæ›´å‹å¥½
        CLEAN_TITLE=$(echo "$POST_TITLE" | tr -d '[:punct:]' | tr ' ' '-')
        FILENAME="${TOPIC_ID}-${CLEAN_TITLE}.md"
        FULL_FORUM_URL="$POST_SOURCE_URL"
        if [[ ! "$POST_SOURCE_URL" == http* ]]; then
          FULL_FORUM_URL="${FORUM_BASE_URL}${POST_SOURCE_URL}"
        fi
        # æ ‡ç­¾æ•°ç»„è½¬å­—ç¬¦ä¸²
        TAGS_STRING=$(echo "$POST_TAGS_JSON" | jq -r 'map(select(. != "ç²¾å")) | join(", ")')
        # è®¾ç½®æ–‡ä»¶è·¯å¾„ï¼ˆå¯ä»¥æ ¹æ®éœ€è¦ä¿®æ”¹ï¼‰
        FILEPATH="PKMerè®ºå›/${FILENAME}"
        
        # åˆ›å»ºç›®å½•
        mkdir -p $(dirname "$FILEPATH")
        
        # åˆ›å»º Markdown æ–‡ä»¶å†…å®¹
        cat > "$FILEPATH" << EOF
        ---
        uid: ${POST_ID}
        title: ${POST_TITLE}
        tags: [${TAGS_STRING}]
        description: ${POST_TITLE}
        author: ${POST_AUTHOR}
        type: other
        draft: false
        editable: false
        modified: ${POST_TIMESTAMP}
        forum_url: ${FULL_FORUM_URL}
        ---
        
        # ${POST_TITLE}
        
        > [!INFO] æœ¬æ–‡æ¡£ç”± PKMer è®ºå›å¯¼å…¥  
        > - ä½œè€…: ${POST_AUTHOR}
        > - åŸå§‹é“¾æ¥: [${POST_TITLE}](${FULL_FORUM_URL})
        
        ---
        
        ${POST_RAW_CONTENT}
        
        EOF
        
        echo "filepath=$FILEPATH" >> $GITHUB_OUTPUT
        echo "filename=$FILENAME" >> $GITHUB_OUTPUT
        
    # - name: Create Pull Request
    #   uses: peter-evans/create-pull-request@v5
    #   with:
    #     token: ${{ secrets.PAT_TOKEN }}
    #     commit-message: |
    #       æ·»åŠ  PKMerè®ºå› å¸–å­: ${{ github.event.client_payload.title }}
          
    #       - Post ID: ${{ github.event.client_payload.post_id }}
    #       - Author: ${{ github.event.client_payload.author  }}
    #       - Source: https://forum.pkmer.net${{ github.event.client_payload.source_url }}
    #     branch: forum-post-${{ github.event.client_payload.post_id }}
    #     delete-branch: true
    #     title: |
    #       ${{ github.event.client_payload.title }}
    #     body: |
    #       ## ğŸ“ PKMerè®ºå› å¸–å­å¯¼å…¥
          
    #       æœ¬ PR è‡ªåŠ¨ä»  PKMer è®ºå›å¯¼å…¥å¸–å­å†…å®¹ã€‚
          
    #       ### å¸–å­ä¿¡æ¯
    #       - **æ ‡é¢˜**: ${{ github.event.client_payload.title }}
    #       - **ä½œè€…**: @${{ github.event.client_payload.author }}
    #       - **å¸–å­ ID**: ${{ github.event.client_payload.post_id }}
    #       - **åŸå§‹é“¾æ¥**: https://forum.pkmer.net${{ github.event.client_payload.source_url }}
          
    #       ### æ–‡ä»¶è·¯å¾„
    #       - ğŸ“„ `${{ steps.create_content.outputs.filepath }}`
          
          
      
    #     labels: |
    #       auto-generated
    #       forum-post
    - name: 3. Commit and Push to main branch
      run: |
        # æŠŠæ–°åˆ›å»ºæˆ–ä¿®æ”¹çš„æ–‡ä»¶æ·»åŠ åˆ°æš‚å­˜åŒº
        git add '${{ steps.prepare_file.outputs.filepath }}'
        
        # æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶å˜æ›´ã€‚å¦‚æœæ²¡æœ‰å˜æ›´ï¼ˆæ¯”å¦‚é‡å¤è§¦å‘ï¼‰ï¼Œå°±é€€å‡º
        if git diff --staged --quiet; then
          echo "âœ… No changes to commit. Working tree clean."
          exit 0
        fi
        # æ ¹æ®æ˜¯æ›´æ–°è¿˜æ˜¯æ–°å»ºï¼Œç”Ÿæˆä¸åŒçš„ commit message
        COMMIT_MESSAGE="${{ steps.prepare_file.outputs.is_update == 'true' && 'docs(forum): æ›´æ–°å¸–å­' || 'docs(forum): æ·»åŠ æ–°å¸–' }} L${{ github.event.client_payload.topic_id }}
        - æ ‡é¢˜: ${{ github.event.client_payload.title }}"
        # æ‰§è¡Œæäº¤
        git commit -m "$COMMIT_MESSAGE"
        
        # æ¨é€åˆ°è¿œç¨‹ main åˆ†æ”¯
        echo "ğŸš€ Pushing changes to main branch..."
        git push origin main       

