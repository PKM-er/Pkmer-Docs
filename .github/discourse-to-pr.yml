name: Create PR from PKMer Forum Post

on:
  repository_dispatch:
    types: [PKMer_forum_post]

jobs:
  create-pr:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Setup Git
      run: |
        git config --global user.name "pkmer Bot"
        git config --global user.email "pkmer.cn"
    
    - name: Create content from  PKMer Forum post
      id: create_content
      run: |
        # åˆ›å»ºæ–‡ä»¶è·¯å¾„å’Œå†…å®¹
        POST_ID="${{ github.event.client_payload.post_id }}"
        TOPIC_ID="${{ github.event.client_payload.topic_id }}"
        TIMESTAMP=$(date +%Y%m%d_%H%M%S)
        
        # ç”Ÿæˆæ–‡ä»¶åï¼ˆä½¿ç”¨ topic_slug æˆ– topic_idï¼‰
        TOPIC_SLUG="${{ github.event.client_payload.topic_slug }}"
        if [ -z "$TOPIC_SLUG" ]; then
          FILENAME="${TOPIC_ID}_${POST_ID}.md"
        else
          # æ¸…ç† slugï¼Œåªä¿ç•™å­—æ¯æ•°å­—å’Œè¿å­—ç¬¦
          CLEAN_SLUG=$(echo "$TOPIC_SLUG" | sed 's/[^a-zA-Z0-9-]/-/g')
          FILENAME="${CLEAN_SLUG}_${POST_ID}.md"
        fi
        
        # è®¾ç½®æ–‡ä»¶è·¯å¾„ï¼ˆå¯ä»¥æ ¹æ®éœ€è¦ä¿®æ”¹ï¼‰
        FILEPATH="/PKMerè®ºå›/${FILENAME}"
        
        # åˆ›å»ºç›®å½•
        mkdir -p $(dirname "$FILEPATH")
        
        # åˆ›å»º Markdown æ–‡ä»¶å†…å®¹
        cat > "$FILEPATH" << 'EOF'
        ---
        uid: ${{ github.event.client_payload.post_id }}
        title: ${{ github.event.client_payload.topic_title }}
        tags: [ ${{ github.event.client_payload.tags }}]
        description: ${{ github.event.client_payload.topic_title }}
        author: ${{ github.event.client_payload.username }}
        type: other
        draft: false
        editable: false
        modified: ${{ github.event.client_payload.updated_at }}
        created: ${{ github.event.client_payload.created_at }}
        forum_url: ${{ github.event.client_payload.discourse_url }}
        topic_id: ${{ github.event.client_payload.topic_id }}
        ---
        
        # ${{ github.event.client_payload.topic_title }}
        
        > æœ¬æ–‡æ¡£ä» PKMer è®ºå›è‡ªåŠ¨å¯¼å…¥
        > 
        > - ä½œè€…: ${{ github.event.client_payload.username }}
        > - å‘å¸ƒæ—¶é—´: ${{ github.event.client_payload.created_at }}
        > - åŸå§‹é“¾æ¥: ${{ github.event.client_payload.discourse_url }}
        > - å¸–å­ç¼–å·: #${{ github.event.client_payload.post_number }}
        
        ---
        
        ${{ github.event.client_payload.raw }}
        
        EOF
        
        echo "filepath=$FILEPATH" >> $GITHUB_OUTPUT
        echo "filename=$FILENAME" >> $GITHUB_OUTPUT
        
    - name: Create Pull Request
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: |
          æ·»åŠ  PKMerè®ºå› å¸–å­: ${{ github.event.client_payload.topic_title }}
          
          - Post ID: ${{ github.event.client_payload.post_id }}
          - Author: ${{ github.event.client_payload.username }}
          - Source: ${{ github.event.client_payload.discourse_url }}
        branch: forum-post-${{ github.event.client_payload.post_id }}
        delete-branch: true
        title: |
          ${{ github.event.client_payload.topic_title }}
        body: |
          ## ğŸ“ PKMerè®ºå› å¸–å­å¯¼å…¥
          
          æœ¬ PR è‡ªåŠ¨ä»  PKMer è®ºå›å¯¼å…¥å¸–å­å†…å®¹ã€‚
          
          ### å¸–å­ä¿¡æ¯
          - **æ ‡é¢˜**: ${{ github.event.client_payload.topic_title }}
          - **ä½œè€…**: @${{ github.event.client_payload.username }}
          - **å¸–å­ ID**: ${{ github.event.client_payload.post_id }}
          - **Topic ID**: ${{ github.event.client_payload.topic_id }}
          - **åˆ›å»ºæ—¶é—´**: ${{ github.event.client_payload.created_at }}
          - **åŸå§‹é“¾æ¥**: ${{ github.event.client_payload.discourse_url }}
          
          ### æ–‡ä»¶è·¯å¾„
          - ğŸ“„ `${{ steps.create_content.outputs.filepath }}`
          
          
      
        labels: |
          auto-generated
          documentation
        assignees: |
          ${{ github.repository_owner }}
          
    - name: PR Created Successfully
      if: success()
      run: |
        echo "âœ… PR åˆ›å»ºæˆåŠŸï¼"
        echo "Post ID: ${{ github.event.client_payload.post_id }}"
        echo "Topic: ${{ github.event.client_payload.topic_title }}"
        
    - name: Handle Failure
      if: failure()
      run: |
        echo "âŒ PR åˆ›å»ºå¤±è´¥"
        echo "Error details available in workflow logs"
