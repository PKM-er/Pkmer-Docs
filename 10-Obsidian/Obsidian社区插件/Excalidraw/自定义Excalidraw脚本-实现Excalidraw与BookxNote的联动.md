---
uid: 20231220152351
title: è‡ªå®šä¹‰ Excalidraw è„šæœ¬ - å®ç° Excalidraw ä¸ BookxNote çš„è”åŠ¨
tags: [å·¥ä½œæµ, pdfæ ‡æ³¨, Excalidrawè„šæœ¬, BookxNote]
description: " è‡ªå®šä¹‰ Excalidraw è„šæœ¬ - Excalidraw ä¸ BookxNote çš„è”åŠ¨"
author: ç†ŠçŒ«åˆ«ç†¬å¤œ
type: other
draft: false
editable: false
modified: 20231229170716
---

# è‡ªå®šä¹‰ Excalidraw è„šæœ¬ - å®ç° Excalidraw ä¸ BookxNote çš„è”åŠ¨

![](https://cdn.pkmer.cn/images/202312201525630.gif!pkmer)

## è„šæœ¬çš„åˆ¶ä½œæ€è·¯

ç»§ [[QuickeråŠ¨ä½œä¹‹BookxNoteå’ŒObsidianè”åŠ¨]] åï¼Œæˆ‘å‘å¸ƒäº†ä¸€ç¯‡ [[è‡ªå®šä¹‰Excalidrawè„šæœ¬-å®ç°Zoteroä¸Excalidrawçš„æ‹–æ‹½è”åŠ¨]] çš„æ–‡ç« å’Œè§†é¢‘ï¼Œæ˜¯é€šè¿‡ Excalidraw çš„è„šæœ¬å®ç° Zotero å’Œ Obsidian çš„ Excalidraw çš„æ‹–æ‹½æ— ç¼è¿æ¥ï¼Œæ•ˆæœè¿˜ä¸é”™ã€‚

æŒ‰ç†è¯´ BookxnotePro ä¹Ÿå¯ä»¥ç›´æ¥é€šè¿‡ Excalidraw è„šæœ¬æ¥å®ç°ï¼Œä½†ä¸€ç›´æ‹–ç€æ²¡å»å®ç°ï¼Œä¸»è¦ Bookxnote çš„æ•°æ®å­˜å‚¨æœ‰ä¸€ç‚¹ç»•ï¼Œæ¯”å¦‚è¿™æ˜¯ä¸€ä¸ª BookxnotePro çš„å¤–éƒ¨é“¾æ¥ï¼š

```text
bookxnotepro://opennote/?nb={ede53699-7b48-4be3-b42c-4aa08bd30ce1}&book=5bde5735bd629aef922f076220efd624&page=49&x=198&y=551&id=181&uuid=0b87d2be8c8b85663d2fd23264e4c866
```

- nbï¼š`{ede53699-7b48-4be3-b42c-4aa08bd30ce1}`
- bookï¼š`5bde5735bd629aef922f076220efd624`
- uuidï¼š`0b87d2be8c8b85663d2fd23264e4c866`

åŒ…å«äº† `nb`ã€`book`ã€`uuid` çš„ 3 ä¸ªä¿¡æ¯ IDï¼Œè®©æˆ‘ä»¬ç®€å•çœ‹çœ‹è¿™ 3 ä¸ªä¿¡æ¯ ID åˆ†åˆ«å¯¹åº”ä»€ä¹ˆã€‚

é¦–å…ˆæ‰¾åˆ° Bookxnote çš„ç¬”è®°æ•°æ®ç›®å½•æ‰€åœ¨çš„æ–‡ä»¶å¤¹ï¼Œåœ¨ Bookxnote é€‰é¡¹çš„åŸºæœ¬è®¾ç½®é‡Œé¢ï¼š

![](https://cdn.pkmer.cn/images/202312201525621.png!pkmer)

æ‰“å¼€å¯ä»¥å‘ç°é‡Œé¢æœ‰å‡ ä¸ªæ•°æ®æ–‡ä»¶ï¼Œéƒ½æ˜¯ç”¨æ¥å­˜å‚¨ Bookxnote è½¯ä»¶è®¾ç½®çš„æ–‡ä»¶ï¼Œæœ‰æœ€è¿‘é˜…è¯»è®°å½• recentnotes.json å’Œç”¨æˆ·è®¾ç½® user_config.jsonã€‚

![](https://cdn.pkmer.cn/images/202312201525622.png!pkmer)

å…¶ä¸­ notebooks æ–‡ä»¶å¤¹æ‰æ˜¯æˆ‘ä»¬è¿™æ¬¡ä¸»è¦å…³æ³¨çš„å¯¹è±¡ï¼Œä¹Ÿæ˜¯æ‰€æœ‰ä¹¦æœ¬ç¬”è®°æ•°æ®å­˜å‚¨ä½ç½®ï¼Œé‡Œé¢æœ‰è®¸å¤šçš„ PDF å¯¹åº”çš„æ–‡ä»¶å¤¹ï¼Œè¿˜æœ‰ 3 ä¸ª JSON æ•°æ®æ–‡ä»¶ï¼Œmanifest.json é‡Œé¢å°±å­˜å‚¨ç€æ‰€æœ‰æ•°æ®çš„åŸºæœ¬ä¿¡æ¯ï¼š

![](https://cdn.pkmer.cn/images/202312201525623.png!pkmer)

åœ¨é‡Œé¢æˆ‘ä»¬å°±å¯ä»¥æ‰¾åˆ°æˆ‘ä»¬ nb å¯¹åº”çš„ ID å€¼ï¼š

![](https://cdn.pkmer.cn/images/202312201525625.png!pkmer)

æœ‰ nb çš„ ID å€¼æˆ‘ä»¬å¯ä»¥æ‰¾åˆ° `entry` å°±æ˜¯ notebook æ–‡ä»¶ä¸‹æ–¹å¯¹åº”ä¹¦ç±çš„æ–‡ä»¶å¤¹åç§°ï¼Œå³æˆ‘ä»¬å¯ä»¥ä» Bookxnote çš„ç¬”è®°ç›®å½•æ•°æ®é€šè¿‡ nb æŸ¥æ‰¾åˆ° PDF å¯¹åº”çš„æ–‡ä»¶å¤¹åç§°ä»è€Œæ¨å‡ºå¯¹åº”çš„**ç¬”è®°æ•°æ®æ–‡ä»¶å¤¹**ã€‚

![](https://cdn.pkmer.cn/images/202312201525626.png!pkmer)

è¿™é‡Œé¢ markups.json æ–‡ä»¶å°±å­˜å‚¨æ‰€æœ‰åœ¨ PDF æ ‡æ³¨çš„ä¿¡æ¯ï¼Œå¯ä»¥é€šè¿‡ uuid æ¥æ‰¾åˆ°å¯¹åº”çš„å€¼ï¼š

![](https://cdn.pkmer.cn/images/202312201525627.png!pkmer)

å¯ä»¥å‘ç°å›¾ç‰‡æ ‡æ³¨å’Œæ–‡å­—æ ‡æ³¨çš„ç»“æ„æ˜¯ä¸ä¸€æ ·çš„ï¼Œä¸»è¦åŒºåˆ«å°±æ˜¯ `imgfile`

å’Œ `originaltext` çš„ä¿¡æ¯çš„ä¸åŒï¼Œå¯ä»¥é€šè¿‡æ˜¯å¦å­˜åœ¨ `imgfile` æ¥åˆ¤æ–­æ ‡æ³¨ä¿¡æ¯ç±»å‹ï¼Œ`fillcolor` ä¿¡æ¯å¯ä»¥ç”¨æ¥ç»™å¤åˆ¶è¿‡æ¥çš„æ–‡æœ¬æ·»åŠ èƒŒæ™¯é¢œè‰²ã€‚

`originaltext` åˆ™æ˜¯æ ‡æ³¨çš„åŸæ–‡çš„æ–‡æœ¬ä¿¡æ¯ï¼Œ`imgfile` å¯¹åº”çš„å€¼å°±æ˜¯å›¾ç‰‡ä¿¡æ¯ï¼Œä¹Ÿå°±æ˜¯åœ¨**ç¬”è®°æ•°æ®æ–‡ä»¶å¤¹**ä¸‹çš„ **imgfiles**æ–‡ä»¶å¤¹é‡Œé¢å­˜å‚¨çš„å›¾ç‰‡å¯¹åº”çš„å›¾ç‰‡åï¼š

![](https://cdn.pkmer.cn/images/202312201525628.png!pkmer)

### æ•´ç†æ€è·¯ + ä»£ç å®ç°

æ ¹æ® BookxnotePro çš„**å¤–éƒ¨å›é“¾**è·å– `nb`, `book`, `uuid` å€¼ï¼Œé€šè¿‡è¯»å–**ç¬”è®°æ•°æ®ç›®å½•**çš„ **notebooks** æ–‡ä»¶å¤¹çš„ **manifest.json** åŒ¹é… `nb` çš„ `id` å€¼å®šä½ PDF çš„æ–‡ä»¶å¤¹åï¼Œå†è¯»å– PDF æ–‡ä»¶å¤¹åçš„ `markups.json` æ–‡ä»¶é€šè¿‡ uuid å®šä½è·å–æ ‡æ³¨ä¿¡æ¯ã€‚

#### é€šè¿‡æ­£åˆ™æ­£åˆ™åŒ¹é…æ¥åŒ¹é…å¤–éƒ¨å›é“¾çš„ nb, book, uuid å€¼

```js
function matchBookxnoteProRegex(backlink) {
    const regex = /nb=({[0-9a-z\-]+})&book=([0-9a-z\-]+).*&uuid=([0-9a-z\-]+)/;

    const matches = backlink.match(regex);
    if (matches) {
        const nb = matches[1];
        const book = matches[2];
        const uuid = matches[3];
        return { nb, book, uuid };
    } else {
        return null;
    }
}

```

#### é€šè¿‡ nb æŸ¥æ‰¾å¯¹åº”çš„ book ä¿¡æ¯

```js
const fs = require('fs');
const path = require('path');

function findNotebooksById(obj, id) {
	if (obj.notebooks && obj.notebooks.length > 0) {
		for (let i = 0; i < obj.notebooks.length; i++) {
			if (obj.notebooks[i].id === id) {
				return obj.notebooks[i];
			} else {
				const result = findNotebooksById(obj.notebooks[i], id);
				if (result) {
					return result;
				}
			}
		}
	}
	return null;
}

// ç¤ºä¾‹ç”¨æ³•
const notebooksData = "D:/PandaNotes/X-å›¾ä¹¦æ–‡ä»¶å­˜å‚¨/ç¬”è®°æ•°æ®/notebooks/manifest.json";
const notebooksJson = JSON.parse(fs.readFileSync(notebooksData, 'utf8'));

const targetId = "{ede53699-7b48-4be3-b42c-4aa08bd30ce1}";
const notebooks = findNotebooksById(notebooksJson, targetId);
console.log(notebooks);

```

#### é€šè¿‡ uuid åŒ¹é…åˆ°æ ‡æ³¨ä¿¡æ¯

```js
const fs = require('fs');
const path = require('path');

function findMarkupsByUuid(obj, uuid) {
    if (Array.isArray(obj.markups)) {
        for (let i = 0; i < obj.markups.length; i++) {
            if (obj.markups[i].uuid === uuid) {
                return obj.markups[i];
            }
            const markupData = findMarkupsByUuid(obj.markups[i], uuid);
            if (markupData) {
                return markupData;
            }
        }
    }

    return null;
}


// ç¤ºä¾‹ç”¨æ³•
const pdfBooknoteData = "D:/PandaNotes/X-å›¾ä¹¦æ–‡ä»¶å­˜å‚¨/ç¬”è®°æ•°æ®/notebooks/JavaScripté«˜çº§ç¨‹åºè®¾è®¡ï¼ˆç¬¬4ç‰ˆï¼‰/markups.json";
const markupJson = JSON.parse(fs.readFileSync(pdfBooknoteData, 'utf8'));

const targetUuid = "0b87d2be8c8b85663d2fd23264e4c866";
const markupData = findMarkupsByUuid(markupJson, targetUuid);
console.log(markupData);
```

## Excalidraw è„šæœ¬è®¾ç½®

![](https://cdn.pkmer.cn/images/202312201525629.png!pkmer)

å®ç°ç”±**å¤–éƒ¨å›é“¾**ï¼Œé€šè¿‡ `Ctrl + V` ç²˜è´´åŠ¨ä½œè·å–æ ‡æ³¨ä¿¡æ¯åˆ° Excalidrawï¼Œé™„å¸¦è¿”å›çš„é“¾æ¥ã€‚

## Excalidraw è„šæœ¬å®Œæ•´ä»£ç 

```js
/*

```javascript
*/
const eaApi = ExcalidrawAutomate;
let settings = ea.getScriptSettings();
if (!settings["notebooksPath"]) settings["notebooksPath"] = { value: false };
if (!settings["notebooksPath"].value) {
    new Notice("ğŸ”´è¯·é…ç½®è„šæœ¬çš„ç›¸å…³è®¾ç½®ï¼ï¼", 2000);
    settings = {
        "notebooksPath": {
            value: "",
            description: "BookxNoteProçš„ç¬”è®°æ•°æ®ç›®å½•<br>ğŸ”´æ³¨æ„è·¯å¾„ç¬¦å·éœ€è¦è½¬ä¹‰"
        },
        "copyBookxnoteImageToObsidian": {
            value: true,
            description: "æ˜¯å¦å¤åˆ¶Bookxnoteçš„å›¾ç‰‡åˆ°Obsidianåº“å†…<br>ğŸ”´æ³¨æ„è·¯å¾„ç¬¦å·éœ€è¦è½¬ä¹‰<br>ğŸ€æ³¨ï¼šå¦‚æœå›¾ç‰‡æœ¬èº«å°±å­˜åœ¨äºåº“å†…å°±å¯ä»¥å…³é—­è¯¥é€‰é¡¹"
        },
        "notebooksImagesPath": {
            value: "BookxNotesImages",
            description: "Obsidianæ–‡ä»¶å¤¹ï¼Œç”¨äºå­˜æ”¾Bookxnoteå¤åˆ¶è¿‡æ¥çš„æ ‡æ³¨å›¾ç‰‡ï¼Œè¯·ç”¨ç›¸å¯¹äºåº“çš„è·¯å¾„"
        },
    };
    ea.setScriptSettings(settings);
} else {
    new Notice("âœ…BookxnoteproToExcalidrawè„šæœ¬å·²å¯åŠ¨ï¼");
}

// let api = ea.getExcalidrawAPI();
const fs = require('fs');
// const path = require('path');

// è·å–bookxnoteProçš„ç¬”è®°æ•°æ®æ–‡ä»¶å¤¹
const notebookFolder = `${settings["notebooksPath"].value}/notebooks`;

// è·å–notebooksImagesçš„å­˜å‚¨è·¯å¾„
const basePath = (app.vault.adapter).getBasePath();
const notebooksImagesPath = `${basePath}/${settings["notebooksImagesPath"].value}`;

// è¯»å–manifest.jsonæ•°æ®
const notebooksData = `${notebookFolder}/manifest.json`;

const notebooksJson = JSON.parse(fs.readFileSync(notebooksData, 'utf8'));
// console.log(notebooksJson)

// æ·»åŠ é€‰æ‹©æ˜¯å¦åŒ¹é…é¢œè‰²
let InsertStyle;
const fillStyles = ["æ–‡å­—", "èƒŒæ™¯"];
InsertStyle = await utils.suggester(fillStyles, fillStyles, "é€‰æ‹©æ’å…¥å¡ç‰‡é¢œè‰²çš„å½¢å¼ï¼ŒESCåˆ™ä¸ºç™½åº•é»‘å­—)");

eaApi.onPasteHook = async function ({ ea,
    payload,
    event,
    excalidrawFile,
    view,
    pointerPosition
}) {
    console.log("onPaste");
    event.preventDefault();
    const backlink = payload.text;
    console.log(payload.text);
    if (payload?.text?.startsWith('bookxnotepro://opennote')) {
        console.log("åŒ¹é…æˆåŠŸ");
        // æ¸…ç©ºåŸæœ¬æŠ•å…¥çš„æ–‡æœ¬
        event.stopPropagation();
        payload.text = "";
        ea.clear();
        ea.style.fillStyle = 'solid';
        ea.style.roughness = 0;
        // ea.style.roundness = { type: 3 }; // åœ†è§’
        ea.style.strokeWidth = 2;
        ea.style.fontFamily = 4;
        ea.style.fontSize = 20;

        // åŒ¹é…å¤–éƒ¨å›é“¾å¯¹åº”çš„ä¿¡æ¯
        const { nb, book, uuid } = matchBookxnoteProRegex(backlink);
        console.log({ nb, book, uuid });

        // é€šè¿‡nbæ‰¾åˆ°å¯¹åº”çš„ä¹¦æœ¬ä¿¡æ¯
        const notebooks = findNotebooksById(notebooksJson, nb);
        console.log(notebooks);

        // è·å–å½“å‰ä¹¦ç±çš„markups.jsonæ–‡ä»¶ï¼š
        const booknoteMarkupsPath = `${notebookFolder}/${notebooks.entry}/markups.json`;
        console.log(booknoteMarkupsPath);
        const markupsJson = JSON.parse(fs.readFileSync(booknoteMarkupsPath, 'utf8'));
        // console.log(markupsJson)

        // è·å–è¿æ¥çš„æ ‡æ³¨ä¿¡æ¯
        const markupData = findMarkupsByUuid(markupsJson, uuid);
        // console.log(markupData?.originaltext);

        if (markupData?.imgfile) {
            console.log("å›¾ç‰‡æ ‡æ³¨");
            const imgfilePath = `${notebookFolder}/${notebooks.entry}/imgfiles/${markupData.imgfile}`;
            const imgName = `bxn_${markupData.imgfile}`;
            // å¤åˆ¶å›¾ç‰‡åˆ°Obsidiançš„ç¬”è®°åº“
            if (settings["copyBookxnoteImageToObsidian"].value) {
                // æ£€æŸ¥æ–‡ä»¶å¤¹æ˜¯å¦å­˜åœ¨
                if (!fs.existsSync(notebooksImagesPath)) {
                    // åˆ›å»ºæ–‡ä»¶å¤¹
                    fs.mkdirSync(notebooksImagesPath);
                    new Notice(`å›¾ç‰‡æ–‡ä»¶ä¸å­˜åœ¨ï¼Œå·²åˆ›å»ºæ–‡ä»¶å¤¹ï¼š<br>${notebooksImagesPath}`, 3000);

                } else {
                    console.log('æ–‡ä»¶å¤¹å·²å­˜åœ¨');
                }
                fs.copyFileSync(imgfilePath, `${notebooksImagesPath}/${imgName}`);
                await new Promise((resolve) => setTimeout(resolve, 200)); // æš‚åœ0.2ç§’ï¼Œç­‰å¾…å¤åˆ¶æ–‡ä»¶çš„è¿‡ç¨‹
            }

            let id = await ea.addImage(0, 0, imgName);
            let el = ea.getElement(id);
            el.link = backlink;
            ea.setView("active");
            await ea.addElementsToView(true, false, false);
        } else if (markupData?.originaltext) {
            console.log("æ–‡å­—æ ‡æ³¨");

            const fillcolor = `#${markupData.fillcolor.slice(2)}`;

            if (InsertStyle == "èƒŒæ™¯") {
                ea.style.backgroundColor = fillcolor;
                ea.style.strokeColor = "#1e1e1e";
            } else if (InsertStyle == "æ–‡å­—") {
                ea.style.backgroundColor = "#ffffff";
                ea.style.strokeColor = fillcolor;
            } else {
                ea.style.backgroundColor = "transparent";
                ea.style.strokeColor = "#1e1e1e";
            }

            const markupText = processText(markupData.originaltext);
            console.log(markupText);
            let id = await ea.addText(0, 0, `${markupText}`, { width: 600, box: true, wrapAt: 90, textAlign: "left", textVerticalAlign: "middle", box: "box" });
            let el = ea.getElement(id);
            el.link = backlink;
            ea.setView("active");
            await ea.addElementsToView(true, false, false);
        } else {
            new Notice("æœªåŒ¹é…åˆ°æ ‡æ³¨ä¿¡æ¯ï¼Œè¯·é‡æ–°æ ‡æ³¨æˆ–è€…æ‰‹åŠ¨æ’å…¥");
        }

        return false;
    }
    // return true;
};

function matchBookxnoteProRegex(backlink) {
    const regex = /nb=({[0-9a-z\-]+})&book=([0-9a-z\-]+).*&uuid=([0-9a-z\-]+)/;

    const matches = backlink.match(regex);
    if (matches) {
        const nb = matches[1];
        const book = matches[2];
        const uuid = matches[3];
        return { nb, book, uuid };
    } else {
        return null;
    }
}

function findNotebooksById(obj, id) {
    if (obj.notebooks && obj.notebooks.length > 0) {
        for (let i = 0; i < obj.notebooks.length; i++) {
            if (obj.notebooks[i].id === id) {
                return obj.notebooks[i];
            } else {
                const result = findNotebooksById(obj.notebooks[i], id);
                if (result) {
                    return result;
                }
            }
        }
    }
    return null;
}

function findMarkupsByUuid(obj, uuid) {
    if (Array.isArray(obj.markups)) {
        for (let i = 0; i < obj.markups.length; i++) {
            if (obj.markups[i].uuid === uuid) {
                return obj.markups[i];
            }
            const markupData = findMarkupsByUuid(obj.markups[i], uuid);
            if (markupData) {
                return markupData;
            }
        }
    }

    return null;
}

function processText(text) {
    // æ›¿æ¢ç‰¹æ®Šç©ºæ ¼ä¸ºæ™®é€šç©ºæ ¼
    text = text.replace(/[\ue5d2\u00a0\u2007\u202F\u3000\u314F\u316D\ue5cf]/g, ' ');
    // å°†å…¨è§’å­—ç¬¦è½¬æ¢ä¸ºåŠè§’å­—ç¬¦
    text = text.replace(/[\uFF01-\uFF5E]/g, function (match) { return String.fromCharCode(match.charCodeAt(0) - 65248); });
    // æ›¿æ¢è‹±æ–‡ä¹‹é—´çš„å¤šä¸ªç©ºæ ¼ä¸ºä¸€ä¸ªç©ºæ ¼
    text = text.replace(/([a-zA-Z])([\u4e00-\u9fa5])/g, '$1 $2');

    // åˆ é™¤ä¸­æ–‡ä¹‹é—´çš„ç©ºæ ¼
    text = text.replace(/([0-9\.\u4e00-\u9fa5])\s+([0-9\.\u4e00-\u9fa5])/g, '$1$2');
    text = text.replace(/([0-9\.\u4e00-\u9fa5])\s+([0-9\.\u4e00-\u9fa5])/g, '$1$2');
    text = text.replace(/([\u4e00-\u9fa5])\s+/g, '$1');
    text = text.replace(/\s+([\u4e00-\u9fa5])/g, '$1');

    // // åœ¨ä¸­è‹±æ–‡ä¹‹é—´æ·»åŠ ç©ºæ ¼
    // text = text.replace(/([\u4e00-\u9fa5])([a-zA-Z])/g, '$1 $2');
    // text = text.replace(/([a-zA-Z])([\u4e00-\u9fa5])/g, '$1 $2');

    return text;
}
```
